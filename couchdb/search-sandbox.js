{
    "_id": "_design/search-sandbox",
    "views": {
        "metadata": {
            "map": "//----------------------------------------------------------------------------------------\n// Handle both string and array values, and multilingual values\nfunction get_title(csl) {\n  var title = '';\n\n  // do we have titles in multiple languages? If so, concatenate them\n  if (csl['multi']) {\n    for (var i in csl['multi']._key) {\n      switch (i) {\n        case 'title':\n          title = '';\n\n          for (var language in csl['multi']._key[i]) {\n            title += csl['multi']._key[i][language] + ' ';\n          }\n          break;\n\n        default:\n          break;\n      }\n    }\n  }\n\n  if (title == '') {\n    if (csl['title']) {\n      if (Array.isArray(csl['title'])) {\n        for (var i in csl['title']) {\n          title = csl['title'][i] + ' ';\n        }\n      } else {\n        title = csl['title'] + ' ';\n      }\n    }\n  }\n\n  return title;\n}\n\n//----------------------------------------------------------------------------------------\n// Handle both string and array values, and multilingual values\nfunction get_container(csl) {\n  var container = '';\n\n  // do we have container-title in multiple languages? If so, concatenate them\n  if (csl['multi']) {\n    for (var i in csl['multi']._key) {\n      switch (i) {\n        case 'container-title':\n          container = '';\n\n          for (var language in csl['multi']._key[i]) {\n            container += csl['multi']._key[i][language] + ' ';\n          }\n          break;\n\n        default:\n          break;\n      }\n    }\n  }\n\n  if (container == '') {\n    if (csl['container-title']) {\n      if (Array.isArray(csl['container-title'])) {\n        container = csl['container-title'][0] + ' ';\n      } else {\n        container = csl['container-title'] + ' ';\n      }\n    }\n  }\n\n  return container;\n\n}\n\n//----------------------------------------------------------------------------------------\nfunction get_authors(csl) {\n  var authorstring = '';\n\n\n  if (csl.author) {\n    var authors = [];\n\n    for (var i in csl.author) {\n      if (csl.author[i]['multi']) {\n        for (var j in csl.author[i]['multi']._key) {\n          switch (j) {\n            case 'literal':\n            case 'name':\n              for (var language in csl.author[i]['multi']._key[j]) {\n                authors.push(csl.author[i]['multi']._key[j][language]);\n              }\n              break;\n\n            default:\n              break;\n          }\n        }\n      }\n    }\n\n\n    if (authors.length == 0) {\n      for (var i in csl.author) {\n        var name = '';\n        if (csl.author[i].literal) {\n          name = csl.author[i].literal;\n        } else {\n          if (csl.author[i].given) {\n            name += csl.author[i].given;\n          }\n          if (csl.author[i].family) {\n            name += ' ' + csl.author[i].family;\n          }\n        }\n        authors.push(name);\n      }\n    }\n\n    authorstring = authors.join(';');\n  }\n\n\n\n  return authorstring;\n}\n\n\n//----------------------------------------------------------------------------------------\nfunction emit_author_facet(csl, cloudant) {\n  if (csl.author) {\n    for (var i in csl.author) {\n\n      var done = false;\n\n      // do we have authors in multiple languages? If so, output each one as a facet\n      if (csl.author[i]['multi']) {\n        for (var j in csl.author[i]['multi']._key) {\n          switch (j) {\n            case 'literal':\n            case 'name':\n              done = true;\n\n              for (var language in csl.author[i]['multi']._key[j]) {\n                if (cloudant) {\n                  index(\"author\", csl.author[i]['multi']._key[j][language], {\n                    \"facet\": true\n                  });\n                } else {\n                  emit(\"author\", [csl.author[i]['multi']._key[j][language], {\n                    \"facet\": true\n                  }]);\n                }\n              }\n              break;\n\n            default:\n              break;\n          }\n        }\n      }\n\n      // If no multilingual just do default\n      if (!done) {\n        var name = '';\n        if (csl.author[i].literal) {\n          name = csl.author[i].literal;\n        } else {\n          if (csl.author[i].given) {\n            name += csl.author[i].given;\n          }\n          if (csl.author[i].family) {\n            name += ' ' + csl.author[i].family;\n          }\n        }\n        if (cloudant) {\n          index(\"author\", name, {\n            \"facet\": true\n          });\n        } else {\n          emit(\"author\", [name, {\n            \"facet\": true\n          }]);\n        }\n      }\n\n\n    }\n  }\n}\n\n\n//----------------------------------------------------------------------------------------\nfunction emit_container_facet(csl, cloudant) {\n  if (csl['container-title']) {\n    var done = false;\n\n    // do we have titles in multiple languages? If so, concatenate them\n    if (csl['multi']) {\n      for (var i in csl['multi']._key) {\n        switch (i) {\n          case 'container-title':\n            done = true;\n\n            for (var language in csl['multi']._key[i]) {\n              var container = csl['multi']._key[i][language];\n\n              if (cloudant) {\n                index(\"container\", container, {\n                  \"facet\": true\n                });\n              } else {\n                emit(\"container\", [container, {\n                  \"facet\": true\n                }]);\n              }\n            }\n            break;\n\n          default:\n            break;\n        }\n      }\n    }\n\n\n    if (!done) {\n      var container = '';\n      if (Array.isArray(csl['container-title'])) {\n        container = csl['container-title'][0];\n      } else {\n        container = csl['container-title'];\n      }\n      if (cloudant) {\n        index(\"container\", container, {\n          \"facet\": true\n        });\n      } else {\n        emit(\"container\", [container, {\n          \"facet\": true\n        }]);\n      }\n    }\n  }\n\n}\n\n//----------------------------------------------------------------------------------------\nfunction emit_year_facet(csl, cloudant) {\n  if (csl.issued) {\n    if (cloudant) {\n      index(\"year\", csl.issued['date-parts'][0][0].toString(), {\n        \"facet\": true\n      });\n    } else {\n      emit(\"year\", [csl.issued['date-parts'][0][0].toString(), {\n        \"facet\": true\n      }]);\n    }\n  }\n}\n\n\nfunction (doc) {\n  var cloudant = false;\n  \n  if (doc._id != doc.cluster_id) {\n    return;\n  }\n\n  var csl = doc.message;\n  if (csl) {\n    var text = '';\n\n    text += get_authors(csl) + ' ';\n\n    if (csl.issued) {\n      text += csl.issued['date-parts'][0][0] + ' ';\n    }\n\n    // title and container-title\t\n    if (csl.title || csl.source) {\n\t\ttext += get_title(csl);\n\t    text += get_container(csl);\n\t} else {\n   \t if (csl.unstructured) {\n     \t text += csl.unstructured + ' ';\n   \t  }\n\t}\n\n    if (csl.volume) {\n      text += csl.volume + ' ';\n    }\n    if (csl.issue) {\n      text += csl.issue + ' ';\n    }\n    if (csl.page) {\n      text += csl.page + ' ';\n    }\n\n    text = text.replace(/\\s+$/, '');\n\n    // http://stackoverflow.com/a/822464\n    text = text.replace(/<(?:.|\\n)*?>/gm, '');\n\n    if (cloudant) {\n      index(\"default\", text, {\n        \"store\": \"yes\"\n      });\n    } else {\n      emit(\"default\", [text, {\n        \"store\": \"yes\"\n      }]);\n    }\n\n    // facets \n    emit_author_facet(csl, cloudant);\n\n    emit_container_facet(csl, cloudant);\n\n    emit_year_facet(csl, cloudant);\n\n  }\n}\n"
        }
    },
    "language": "javascript"
}